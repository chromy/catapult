<!DOCTYPE html>
<!--
Copyright 2016 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<script src="/jquery/jquery-2.1.4.min.js"></script>
<script src="/flot/jquery.flot.min.js"></script>
<script src="/flot/jquery.flot.crosshair.min.js"></script>
<script src="/flot/jquery.flot.fillbetween.min.js"></script>
<script src="/flot/jquery.flot.selection.min.js"></script>

<link rel="import" href="/dashboard/elements/memory-report-page.html">
<link rel="import" href="/dashboard/static/testdata/memory-charts.html">
<link rel="import" href="/dashboard/static/testing_common.html">

<link rel="import" href="/tracing/core/test_utils.html">

<script>
'use strict';

var REPORT_JSON = {
  'login_url': 'https:do/not/click',
  'revision_info': {
    'r_commit_pos': {
      'url': 'http://test-results/revision_range?start={{R1}}&end={{R2}}',
      'name': 'Chromium Commit Position'
    },
    'r_chromium': {
      'url': 'http://test-results/revision_range?start={{R1}}&end={{R2}}',
      'name': 'Chromium git hash'
    },
    'r_webkit_rev': {
      'url': 'http://test-results/revision_range?start={{R1}}&end={{R2}}',
      'name': 'WebKit Commit Position'
    },
  },
  'is_internal_user': false,
  'warning_bug': null,
  'test_suites': {
    'system_health.memory_mobile': {
      'des': 'Mobile Chrome Memory System Health Benchmark.',
      'mas': {
        'ChromiumPerf': {
          'android-nexus5': false,
          'android-nexus5X': false,
          'android-nexus6': false,
        }
      },
      'mon': [
        'memory:chrome:all_processes:reported_by_chrome:blink_gc:effective_size_avg/browse_media/browse_media_facebook'
      ]
    },
  },
  'xsrf_token': 'aaaaa'
};

var SHORT_URI_JSON = {
  'charts': [[
    ['ChromiumPerf/android-nexus5/system_health.memory_mobile/memory:chrome:all_processes:reported_by_chrome:allocated_objects_size_avg/background_media/background_media_imgur', ['background_media_imgur']]
  ]]
};

var MOCK_SUBTEST_DICT = {
  'memory:chrome:all_processes:reported_by_chrome:allocated_objects_size_avg': {
    'sub_tests': {
      'background_media': {
        'sub_tests': {
          'background_media_imgur': {
            'sub_tests': {}
          }
        }
      },
      'browse_social': {
        'sub_tests': {
          'browse_social_facebook': {
            'sub_tests': {}
          }
        }
      },
    }
  }
};

tr.b.unittest.testSuite(function() {

  var originalGetQueryString;
  
  function mockXHR() {
    testing_common.addXhrMock(
        '/list_tests?bot=android-nexus5X&suite=system_health.memory_mobile&' +
        'type=sub_tests&xsrf_token=aaaaa',
        JSON.stringify(MOCK_SUBTEST_DICT));
    testing_common.addXhrMock(
        '/list_tests?bot=android-nexus5&suite=system_health.memory_mobile&' +
        'type=sub_tests&xsrf_token=aaaaa',
        JSON.stringify(MOCK_SUBTEST_DICT));
    testing_common.addXhrMock(
        '/list_tests?bot=android-nexus6&suite=system_health.memory_mobile&' +
        'type=sub_tests&xsrf_token=aaaaa',
        JSON.stringify(MOCK_SUBTEST_DICT));
  }

  var testOptions = {
    setUp: function() {
      originalGetQueryString = uri.getQueryString;
      mockXHR();
    },
    tearDown: function() {
      uri.getQueryString = originalGetQueryString;
      testing_common.clearXhrMock();
    }
  };

  test('instantiate', function() {
    // Use a query string with an sid param to load a chart based automatically.
    uri.getQueryString = function() { return '?sid=12345'; };

    // Mock out the basic data neede by the /report page.
    testing_common.addXhrMock('/report?sid=12345', JSON.stringify(REPORT_JSON));

    // Mock out the request to /short_uri to get which charts to load from sid.
    testing_common.addXhrMock(
        '/short_uri?sid=12345', JSON.stringify(SHORT_URI_JSON));

    // Make the charts load when requested.
    testing_common.mockChartJson(memoryCharts, null, '12345');

    var button = document.createElement('button');
    button.textContent = 'Mock XHR';
    button.addEventListener('click', () => mockXHR());
    this.addHTMLOutput(button);

    // The memory-report-page uses all these elements.
    var page = document.createElement('memory-report-page');
    this.addHTMLOutput(page);
  }, testOptions);

});
</script>

<!DOCTYPE html>
<!--
Copyright 2016 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<link rel="import" href="/dashboard/elements/chart-container.html">
<link rel="import" href="/dashboard/elements/login-warning.html">
<link rel="import" href="/dashboard/elements/memory-test-picker.html">
<link rel="import" href="/components/paper-spinner/paper-spinner.html">
<link rel="import" href="/dashboard/static/simple_xhr.html">
<link rel="import" href="/dashboard/static/uri.html">

<dom-module id="memory-report-page">
  <template>
    <style include="iron-flex iron-flex-alignment">
      .section {
        padding: 8px;
        margin: 20px auto;
        position: relative;
        max-width: 90%;
      }
    </style>


    <login-warning id="login-warning" login-link="{{loginUrl}}"
                   hidden$="{{isInternalUser}}">
    </login-warning>
    <div class="section tests">
      <div class="layout horizontal flex-auto center">
        <autocomplete-box
          class="flex-auto"
          datalist={{suites}}
          placeholder="Suite"
          on-dropdownselect="onSuiteSelect"
          id="selection-suite"></autocomplete-box>
        <autocomplete-box
          class="flex-auto"
          datalist={{devices}}
          placeholder="Device"
          on-dropdownselect="onDeviceSelect"
          id="selection-device"></autocomplete-box>
        <paper-spinner id="subtest-spinner" active$="[[subtestsLoading]]"></paper-spinner>
      </div>
    </div>

    <div class="section select">
      <memory-test-picker id="memory-test-picker" xsrf-token="{{xsrfToken}}"></memory-test-picker>
    </div>

    <div class="section graphs">
      <section id="charts-container"></section>
    </div>

    <div id="toasts" hidden>
      <div id="warningtoast">
        {{warningMessage}}
        <template is="dom-if" if="{{!!warningBug}}">
          <a href="https://github.com/catapult-project/catapult/issues/{{warningBug}}">See
            bug #{{warningBug}}.</a>
        </template>
      </div>
    </div>

  </template>

  <script>
    'use strict';
    Polymer({

      is: 'memory-report-page',
      properties: {
        charts: {
          type: Array,
          value: () => [],
          notify: true
        },
        onRevisionRange: { observer: 'onRevisionRangeChanged' },
        graphParams: {
          type: Object,
          value: () => ({})
        },
        isInternalUser: {
          type: Boolean,
          value: false
        },
        loginUrl: {
          type: String,
          value: ''
        },
        revisionInfo: {
          type: Object,
          value: () => ({})
        },
        warningBug: {
          type: Number,
          value: 0
        },
        warningMessage: {
          type: String,
          value: ''
        },
        xsrfToken: {
          type: String,
          value: ''
        },
        testSuites: {
          type: Object,
          value: () => ({})
        },

        suites: {
          type: Array,
          value: () => ([
            'system_health.memory_mobile',
          ].map(suite => ({ name: suite })))
        },
        devices: {
          type: Array,
          value: () => ([
            'android-nexus5',
            'android-nexus5X',
            'android-nexus6',
          ].map(device => ({ name: device }))),

          subtestsLoading: {
            type: Boolean,
            value: false
          },
        }
      },

      set subtestDict(subtestDict) {
        this.memoryTestPicker.subtestDict = subtestDict;
      },

      ready: function() {
        simple_xhr.send('/report', uri.getAllParameters(),
          function(response) {
            this.isInternalUser = response['is_internal_user'];
            this.loginUrl = response['login_url'];
            this.revisionInfo = response['revision_info'];
            this.warningBug = response['warning_bug'];
            this.warningMessage = response['warning_message'];
            if (this.warningMessage) {
              this.fire('display-toast', {
                  'content': this.$.warningtoast,
                  'error': true
              });
            }
            this.xsrfToken = response['xsrf_token'];
            this.testSuites = response['test_suites'];
            for (var i = 0; i < this.charts.length; i++) {
              this.setChartData(this.charts[i]);
            }
          }.bind(this),
          function(error) {

          }.bind(this));

        window.addEventListener('pagestaterequest',
                                this.onPageStateRequest.bind(this));

        this.selectSuite = this.$['selection-suite'];
        this.selectSuite.setDataList(this.selectSuite.datalist);
        this.selectDevice = this.$['selection-device'];
        this.selectDevice.setDataList(this.selectDevice.datalist);
        this.subtestSpinner = this.$['subtest-spinner'];

        this.memoryTestPicker = this.$['memory-test-picker'];
        this.memoryTestPicker.addEventListener(
            'add', this.onAddChart.bind(this));

        window.addEventListener('uriload', this.onUriLoad.bind(this));
        this.uriController = new uri.Controller(this.getPageState.bind(this));
        this.uriController.load();
      },

      /**
       * On 'uriload' event, adds charts from the current query parameters.
       * @param {Object} event Event object.
       */
      onUriLoad: function(event) {
        var params = event.detail.params;
        var pageState = event.detail.state;
        if (!pageState) {
          return;
        }
        // Set page level parameters.
        this.graphParams = {};
        for (var key in params) {
          this.graphParams[key] = params[key];
        }

        // Add charts.
        var chartStates = pageState['charts'];
        for (var i = 0; i < chartStates.length; i++) {
          this.addChart(chartStates[i], false);
        }
      },

      /**
       * Updates chart data with member variables.
       * TODO(sullivan): this should be done with polymer templates, not
       * JS code.
       */
      setChartData: function(chart) {
        chart.isInternalUser = this.isInternalUser;
        chart.testSuites = this.testSuites;
        chart.revisionInfo = this.revisionInfo;
        chart.xsrfToken = this.xsrfToken;
        chart.graphParams = this.graphParams;
      },

      /**
       * Adds a chart.
       * @param {Array.<Array>} testPathAndSelected A list of two-element
       *     Arrays, each containing a test path and selected series to plot.
       * @param {boolean} isPrepend True for prepend, false for append.
       */
      addChart: function(testPathAndSelected, isPrepend) {
        console.log('addChart', testPathAndSelected, isPrepend);
        // TODO(sullivan): This should be done with a polymer template, not
        // JavaScript-built DOM!!
        var container = this.$['charts-container'];
        var chart = document.createElement('chart-container');
        if (isPrepend && Polymer.dom(container).children.length > 0) {
          this.charts.unshift(chart);
          Polymer.dom(container).insertBefore(chart,
              Polymer.dom(container).children[0]);
        } else {
          this.charts.push(chart);
          Polymer.dom(container).appendChild(chart);
        }

        chart.addEventListener(
            'chartclosed', this.onChartClosed.bind(this), true);
        chart.addEventListener(
            'chartstatechanged',
            this.uriController.onPageStateChanged.bind(this.uriController));
        chart.addEventListener(
            'revisionrange', this.onRevisionRangeChanged.bind(this));
        this.setChartData(chart);
        chart.addSeriesGroup(testPathAndSelected, true);
      },

      /**
       * On chart closed, update URI.
       */
      onChartClosed: function(event) {
        var chart = event.target;
        var index = this.charts.indexOf(chart);
        if (index > -1) {
          this.charts.splice(index, 1);
        }

        this.fireNumChartChangedEvent();
      },

      /**
       * Triggers page state change handler with 'numchartchanged' event.
       */
      fireNumChartChangedEvent: function() {
        // Send page state change event.
        var event = document.createEvent('Event');
        event.initEvent('numchartchanged', true, true);
        event.detail = {
          'stateName': 'numchartchanged',
          'params': this.graphParams,
          'state': {}
        };

        if (this.charts.length == 0) {
          event.detail['params'] = null;
          this.graphParams = {};
        }

        this.uriController.onPageStateChanged(event);
      },

      /**
       * When the revision range changes for one graph, update the rest of
       * the graphs and the URI.
       */
      onRevisionRangeChanged: function(_, event) {
        for (var i = 0; i < this.charts.length; i++) {
          var chart = this.charts[i];
          if (chart == event.target) {
            continue;
          }
          chart.onRevisionRange(event, event['detail'], null);
        }
      },

      /**
       * Another component wants us to add a chart.
       */
      onAddChart: function(event) {
        var path = event.detail.path;
        var series = event.detail.series;
        this.addChart([[path, series]], true);
        this.fireNumChartChangedEvent();
      },

      /**
       * Gets report page state.
       *
       * @return {Object} Dictionary of page state data.
       */
      getPageState: function() {
        var chartStates = [];
        for (var i = 0; i < this.charts.length; i++) {
          var chart = this.charts[i];
          chartStates.push(chart.getState());
        }

        if (chartStates.length === 0) {
          return null;
        }

        return {
          'charts': chartStates
        };
      },

      /**
       * Handles displaying loading messages on 'pagestaterequest' event.
       */
      onPageStateRequest: function(event) {
        var status = event.detail.status;
        if (status == 'loading') {
          this.fire('display-toast', {'text': 'Saving report...'});
        } else if (status == 'error') {
          this.fire('display-toast', {
              'text': 'Failed to save report.',
              'error': true
          });
        }
      },

      onDeviceSelect: function(event) {
        if (this.device !== this.selectDevice.value) {
          this.device = this.selectDevice.value;
          this.sendSubtestRequest();
        }
      },

      onSuiteSelect: function(event) {
        if (this.suite !== this.selectSuite.value) {
          this.suite = this.selectSuite.value;
          this.sendSubtestRequest();
        }
      },

      sendSubtestRequest: function() {
        if (this.subtestXhr) {
          this.subtestXhr.abort();
          this.subtestXhr = null;
        }
        var device = this.device;
        if (!device) {
          return;
        }
        var suite = this.suite;
        if (!suite) {
          return;
        }

        this.subtestsLoading = true;

        var params = {
          type: 'sub_tests',
          suite: suite,
          bot: device,
          xsrf_token: this.xsrfToken
        };
        this.subtestXhr = simple_xhr.send(
            '/list_tests',
            params,
            function(response) {
              this.subtestsLoading = false;
              this.subtestDict = response;
            }.bind(this),
            function(error) {
              if (error) {
                console.log('Error from sendSubtestRequest.');
              }
              this.subtestsLoading = false;
            }.bind(this));
        },
    });
  </script>
</dom-module>

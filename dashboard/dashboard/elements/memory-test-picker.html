<!DOCTYPE html>
<!--
Copyright 2016 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="/components/iron-icons/iron-icons.html">
<link rel="import" href="/components/paper-button/paper-button.html">
<link rel="import" href="/components/paper-input/paper-input.html">
<link rel="import" href="/components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/components/paper-progress/paper-progress.html">

<link rel="import" href="/dashboard/elements/autocomplete-box.html">
<link rel="import" href="/dashboard/static/simple_xhr.html">
<link rel="import" href="/dashboard/static/testselection.html">

<dom-module id="memory-test-picker">
  <template>
    <style include="iron-flex iron-flex-alignment">
      paper-input {
        max-width: 33%;
      }

      .graph-spec paper-button {
        margin-left: 0px;
        margin-right: 0px;
        color: #4285f4;
      }

      .graph-spec paper-icon-button {
        color: #212121;
      }

      .graph-spec p {
        margin: 8px;
      }

      .results .layout {
        align-items: center;
      }
    </style>

    <div id="container">
      <div>
        <paper-input
            label="Filter"
            disabled$="{{!length_(graphSpecs)}}"
            value="{{query}}">
        </paper-input>
      </div>
      <div class="results">
        <template is="dom-repeat" items="{{matchingGraphSpecs}}">
          <div class="graph-spec layout horizontal">
            <paper-icon-button id="dnd-btn"
                draggable="true"
                icon="open-with"
                on-dragstart="handleGraphSpecDragStart_">
                Drag me
            </paper-icon-button>
            <paper-button on-click="handleGraphSpecAdd_">Add</paper-button>
            <p>{{item.humanName}}</p>
          </div>
        </template>
      </div>
    </div>
  </template>

  <script>
    'use strict';

    var FuzzySelect = function(items, opt_accessor) {
      this.accessor = opt_accessor || ((s) => s); 
      this.items = items;
    }

    FuzzySelect.prototype.filter = function(query) {
      var r = new RegExp('.*'+query.split('').join('.*')+'.*');
      return this.items.filter((item) => r.exec(this.accessor(item)));
    }

    var MemoryGraphSpec = function(config) {
      function check(name) {
        if (config[name] === undefined) {
          throw new Error('In MemoryGraphSpec "' + name + '" undefined.');
        }
        return config[name];
      }
      this.suite = 'system_health.memory_mobile';
      this.bot = check('bot');
      this.browser = check('browser');
      this.processes = check('processes');
      this.subsystemPath = check('subsystemPath');
      this.storyGroup = check('storyGroup');
      this.storyName = check('storyName');
      // Reporter is undefined for some metrics (like dump_count).
      this.reporter = config['reporter'] || null;
    };

    MemoryGraphSpec.fromFlattenedSubtestDictEntry = function(bot, entry) {
      var browser, processes, reporter, subsystem, _;
      if (entry[0].includes('reported_by')) {
        [_, browser, processes, reporter, subsystem] = entry[0].split(':', 5);
      } else {
        [_, browser, processes, subsystem] = entry[0].split(':', 4);
      }
      var subsystemPath = subsystem.split(':');
      var storyGroup = entry[1];
      var storyName = entry[2];
      var storyPath = entry[2].split('_');
      return new MemoryGraphSpec({
        bot: bot,
        browser: browser,
        processes: processes,
        reporter: reporter,
        subsystemPath: subsystemPath,
        storyPath: storyPath,
        storyGroup: storyGroup,
        storyName: storyName,
      });
    };

    MemoryGraphSpec.prototype = {
      get path() {
        var reporter = '';
        if (this.reporter) {
          reporter = this.reporter + ':';
        }
        return 'ChromiumPerf/' + this.bot + '/' + this.suite + '/' +
            'memory:' + this.browser + ':' + this.processes + ':' +
            reporter + this.subsystemPath.join(':') + '/' +
            this.storyGroup + '/' + this.storyName;
      },

      get testPathAndSeries() {
        return [this.path, [this.storyName]];
      },

      get humanName() {
        var reporter = '';
        if (this.reporter) {
          reporter = this.reporter + ':';
        }
        return this.browser + ':' + this.processes + ':' + reporter + 
            this.subsystemPath.join(':') + '/' + this.storyGroup +
            '/' + this.storyName;
      }
    };

    Polymer({
      is: 'memory-test-picker',
      properties: {
        query: {
          type: String,
          notify: true,
          value: () => '',
        },

        graphSpecs: {
          type: Array,
          value: () => [],
        },

        matchingGraphSpecs: {
          type: Array,
          computed: 'matchingGraphSpecs_(query, graphSpecs)',
        },

        selectedPathsAndSeries: {
          type Array,
          value: () => [],
        },
      },

      set subtestDict(dict) {
        var flattenedDict = [...this.flattenSubtestDict_(dict)];
        var bot = 'android-nexus5';
        this.graphSpecs = flattenedDict.map(function(entry) {
          return MemoryGraphSpec.fromFlattenedSubtestDictEntry(bot, entry);
        });
      },

      set subtestDict(dict) {
        var flattenedDict = [...this.flattenSubtestDict_(dict)];
        var bot = 'android-nexus5';
        this.graphSpecs = flattenedDict.map(function(entry) {
          return MemoryGraphSpec.fromFlattenedSubtestDictEntry(bot, entry);
        });
      },

      matchingGraphSpecs_: function(query, graphSpecs) {
        if (query === '') {
          return [];
        }
        var selector = new FuzzySelect(graphSpecs, (spec) => spec.humanName);
        var matches = selector.filter(query);
        return matches.slice(0, 30);
      },

      length_: function(arr) {
        return arr.length;
      },

      /**
       * Handler for adding a new graph.
       */
      handleGraphSpecAdd_(e) {
        var item = e.model.item;
        var pathAndSeries = item.testPathAndSeries;
        this.push('selectedPathsAndSeries', pathAndSeries);
      },

      /**
       * Handler for dragging a graph spec onto an existing graph.
       */
      handleGraphSpecDragStart_: function(event, detail) {
        var item = event.model.item;
        var testPathAndSeries = item.testPathAndSeries;
        event.dataTransfer.setData('type', 'seriesdnd');
        event.dataTransfer.setData('data', JSON.stringify(testPathAndSeries));
        event.dataTransfer.effectAllowed = 'copy';
      },

      flattenSubtestDict_: function* (subtestDict) {
        for (var key in subtestDict) {
          var test = subtestDict[key];
          var subtests = test['sub_tests'];
          if (subtests && Object.keys(subtests).length > 0) {
            for (var a of this.flattenSubtestDict_(subtests)) {
              yield [key].concat(a);
            }
          } else {
            yield [key];
          }
        }
      }
    });
  </script>
</dom-module>
